#include "led.h"
#include "delay.h"
#include "key.h"
#include "sys.h"
#include "usart.h"
#include "timer.h"

 
/************************************************
 ALIENTEK战舰STM32开发板实验10
 输入捕获实验  
 技术支持：www.openedv.com
 淘宝店铺：http://eboard.taobao.com 
 关注微信公众平台微信号："正点原子"，免费获取STM32资料。
 广州市星翼电子科技有限公司  
 作者：正点原子 @ALIENTEK
************************************************/

u8 Way_Angle=1;                             //获取角度的算法，1：四元数  2：卡尔曼  3：互补滤波 
u8 Flag_Qian,Flag_Hou,Flag_Left,Flag_Right,Flag_sudu=2; //蓝牙遥控相关的变量
u8 Flag_Stop=1,Flag_Show=0;                 //停止标志位和 显示标志位 默认停止 显示打开
int Encoder_Left,Encoder_Right;             //左右编码器的脉冲计数
int Moto1,Moto2;                            //电机PWM变量 应是Motor的 向Moto致敬	
int Temperature;                            //显示温度
int Voltage;                                //电池电压采样相关的变量
float Angle_Balance,Gyro_Balance,Gyro_Turn; //平衡倾角 平衡陀螺仪 转向陀螺仪
float Show_Data_Mb;                         //全局显示变量，用于显示需要查看的数据
u32 Distance;                               //超声波测距
u8 delay_50,delay_flag,Bi_zhang=0,PID_Send,Flash_Send;  //延时和调参等变量
float Acceleration_Z;                       //Z轴加速度计
float Balance_Kp=2200,Balance_Kd=2,Velocity_Kp=80,Velocity_Ki=0.4;//PID参数
u16 PID_Parameter[10],Flash_Parameter[10];  //Flash相关数组 

 int main(void)
 {		
 	u32 temp=0; 
	delay_init();	    	 //延时函数初始化	  
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_2);	 //设置NVIC中断分组2:2位抢占优先级，2位响应优先级
	uart_init(115200);	 //串口初始化为115200
 	LED_Init();			     //LED端口初始化
	MiniBalance_PWM_Init(7199,0);   //=====初始化PWM 10KHZ，用于驱动电机 如需初始化电调接口 
	Encoder_Init_TIM2();            //=====编码器接口
    Encoder_Init_TIM4();            //=====初始化编码器2
	Adc_Init();                     //=====adc初始化
	OLED_Init();
	IIC_Init();                     //=====IIC初始化
    MPU6050_initialize();           //=====MPU6050初始化	
    DMP_Init();                     //=====初始化DMP 
	MiniBalance_EXTI_Init();        //=====MPU6050 5ms定时中断初始化
	 
// 	TIM3_PWM_Init(899,0); 		//不分频。PWM频率=72000/(899+1)=80Khz
// 	TIM5_Cap_Init(0XFFFF,72-1);	//以1Mhz的频率计数 
	 
	OLED_P6x8Str(72,7,"Maker:Tyz",0);
   	while(1)
	{
//		printf("Encoder_Left:%x  Encoder_Right:%x",Encoder_Left,Encoder_Right);
//		PWMA=3000;
//		OLED_P8x16Str(0,0,"FM:",0);
		if(Flag_Show==0)          //使用MiniBalance APP和OLED显示屏
		{
			oled_show();          //===显示屏打开
		}
		delay_flag=1;	
		delay_50=0;
		while(delay_flag);	     //通过MPU6050的INT中断实现的50ms精准延时	
		
// 		delay_ms(10);
//		TIM_SetCompare2(TIM3,TIM_GetCapture2(TIM3)+1);

//		if(TIM_GetCapture2(TIM3)==300)TIM_SetCompare2(TIM3,0);	
//		 		 
// 		if(TIM5CH1_CAPTURE_STA&0X80)//成功捕获到了一次上升沿
//		{
//			temp=TIM5CH1_CAPTURE_STA&0X3F;
//			temp*=65536;//溢出时间总和
//			temp+=TIM5CH1_CAPTURE_VAL;//得到总的高电平时间
//			printf("HIGH:%d us\r\n",temp);//打印总的高点平时间
//			TIM5CH1_CAPTURE_STA=0;//开启下一次捕获
//		}
	}
 }

